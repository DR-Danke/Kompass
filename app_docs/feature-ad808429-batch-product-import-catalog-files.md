# Batch Product Import from Supplier Catalog Files

**ADW ID:** ad808429
**Date:** 2026-02-12
**Specification:** specs/issue-123-adw-ad808429-sdlc_planner-batch-product-import-catalog-files.md

## Overview

A standalone CLI script that batch-imports products from 45 supplier catalog files (Excel and PDF) into the products database table. The script leverages the existing extraction service to parse catalog files, resolves supplier and category UUIDs from seed mappings, and bulk-inserts products with correct assignments. It supports dry-run mode, single-file processing, and verbose output for debugging.

## What Was Built

- `apps/Server/scripts/import_products.py` — CLI batch import script (621 lines) with:
  - `FILE_MAP` dictionary mapping 45 catalog files to their supplier and category
  - Seed mappings loader with validation
  - Supplier and category UUID resolution from `seed_mappings.json`
  - `ExtractedProduct` to `ProductCreateDTO` field mapping and conversion
  - Duplicate SKU detection and separate tracking (dupes vs errors)
  - Formatted summary table output with per-file and total counts
  - JSON results export to `scripts/output/import_results.json`
  - CLI flags: `--dry-run`, `--file`, `--verbose`

## Technical Implementation

### Files Modified

- `apps/Server/scripts/import_products.py`: New file — the batch import script (main deliverable)
- `playwright-mcp-config.json`: Minor config update (1 line change)

### Key Changes

- **FILE_MAP** covers 45 catalog files across 11 product categories (BAÑOS, DECK, DISPENSADORES, DOTACION DE COCINA, ESPEJOS, ILUMINACION, MOBILIARIO, ONE STOP SHOP, PISOS, REVESTIMIENTOS, TARIMAS) from 22 distinct suppliers
- **Field mapping** converts `ExtractedProduct` to `ProductCreateDTO`: `price_fob_usd` → `unit_cost`, `moq` → `minimum_order_qty`, `material` is appended to `description`, defaults `origin_country="China"` and `currency="USD"`
- **Deduplication** inspects `BulkCreateResponseDTO.failed` entries for "unique" or "duplicate" keywords in error messages, counting them separately from other errors
- **Graceful error handling** skips files with missing suppliers/categories/paths, skips products with no name, and continues processing remaining files on any per-file failure
- **Sequential processing** iterates files one at a time to avoid database connection pool issues

### Architecture

```
import_products.py
  ├── load_seed_mappings()     → reads scripts/output/seed_mappings.json
  ├── FILE_MAP                 → 45 entries: file_path → {supplier, category}
  ├── resolve_supplier_id()    → lookup supplier UUID from mappings
  ├── resolve_category_id()    → lookup category UUID from mappings
  ├── convert_to_product_dto() → ExtractedProduct → ProductCreateDTO
  ├── process_file()           → extract + convert + bulk_create per file
  ├── print_summary_table()    → formatted console output
  └── write_results_json()     → scripts/output/import_results.json
```

## How to Use

1. Ensure reference data is seeded first:
   ```bash
   cd apps/Server
   python -m scripts.seed_all
   ```

2. Run the full batch import:
   ```bash
   cd apps/Server
   python -m scripts.import_products
   ```

3. Preview without database writes:
   ```bash
   python -m scripts.import_products --dry-run
   ```

4. Process a single file:
   ```bash
   python -m scripts.import_products --file "BAÑOS/GRIFERIASS/HUAYI/HUAYI (1).xlsx"
   ```

5. Enable verbose output (shows each product name, SKU, and price):
   ```bash
   python -m scripts.import_products --verbose
   ```

6. Combine flags:
   ```bash
   python -m scripts.import_products --dry-run --verbose --file "ESPEJOS/LUXDREAM/2026 Luxdream Led Mirror E-Brochure.pdf"
   ```

## Configuration

- **Catalog base path**: `Requirements_Gathering/Sourcing/Data/PROVEEDORES - CATALOGOS/` (resolved relative to repo root)
- **Seed mappings**: `apps/Server/scripts/output/seed_mappings.json` (generated by `seed_all.py`)
- **Results output**: `apps/Server/scripts/output/import_results.json`
- **No new environment variables** or dependencies required

## Testing

- Run `python -m scripts.import_products --dry-run --verbose` to validate extraction and conversion without database writes
- Run `python -m scripts.import_products --help` to verify CLI argument parsing
- Run existing test suite to confirm zero regressions:
  ```bash
  cd apps/Server && .venv/bin/pytest tests/ -v --tb=short
  ```
- Lint the script: `ruff check scripts/import_products.py`

## Notes

- **SKU uniqueness is global**: The database enforces `sku UNIQUE` across all suppliers. Re-running the script is safe — duplicates are counted and logged, not fatal errors
- **Idempotent**: The script can be re-run safely; existing products appear as duplicates in the summary
- **Excluded files**: 7 files are intentionally excluded from FILE_MAP (Canton Fair directory, supplier directories, quotation templates, RFQ template, Chinese-only catalogs)
- **Catalog files location**: Files exist in the main repository under `Requirements_Gathering/Sourcing/Data/PROVEEDORES - CATALOGOS/` but may not be present in worktrees — the script handles missing files gracefully
- **Depends on SCD pipeline**: Requires `seed_mappings.json` from prior seeding (SCD-002). If missing, the script exits with a clear error message
