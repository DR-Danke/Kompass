# HS Code Assignment Script for Products

**ADW ID:** 5310ed8a
**Date:** 2026-02-12
**Specification:** specs/issue-125-adw-5310ed8a-sdlc_planner-assign-hs-codes-to-products.md

## Overview

A standalone CLI script that assigns HS (Harmonized System) codes to imported products based on a hardcoded category-to-HS-code mapping. This is the final piece (SCD-005) in the "Load Supplier Catalog Data" pipeline, enabling the pricing engine to calculate tariffs for automated COP quotations.

## What Was Built

- CLI script `apps/Server/scripts/assign_hs_codes.py` with category-based HS code assignment
- Hardcoded `CATEGORY_HS_MAP` covering 18 categories (17 with HS codes + ONE STOP SHOP mapped to None)
- Category UUID to HS code UUID reverse map built from `seed_mappings.json`
- Optional AI-based HS code suggestion for unmatched/uncategorized products via `--use-ai` flag
- Dry-run mode (`--dry-run`) for previewing changes without database writes
- Verbose mode (`--verbose`) for detailed per-product output
- Formatted summary table and JSON results output

## Technical Implementation

### Files Modified

- `apps/Server/scripts/assign_hs_codes.py`: New script (446 lines) — the main deliverable

### Key Changes

- **Category mapping**: `CATEGORY_HS_MAP` maps 18 category paths (e.g., `BAÑOS/Griferías` -> `7324.90`) to HS code strings, with ONE STOP SHOP explicitly set to `None` for AI/manual handling
- **Reverse map construction**: `build_category_hs_map()` cross-references `seed_mappings.json` category UUIDs and HS code UUIDs to build a `{category_uuid: hs_code_uuid}` lookup
- **Raw SQL bulk query**: `get_products_without_hs_code()` queries all products where `hs_code_id IS NULL` using direct database connection, avoiding pagination limits
- **Two-phase assignment**: Phase 1 assigns via category map; Phase 2 (optional, `--use-ai`) processes unmatched products through `extraction_service.suggest_hs_code()` with 1-second rate limiting
- **AI code matching**: AI suggestions are truncated to 7-char format (`XXXX.XX`) for matching against seeded HS codes; unknown or fallback codes (`9999.99.99`) are skipped

## How to Use

1. Ensure `seed_mappings.json` exists in `apps/Server/scripts/output/` (generated by `python -m scripts.seed_all`)

2. Run category-based assignment only:
   ```bash
   cd apps/Server
   python -m scripts.assign_hs_codes
   ```

3. Preview changes without writing to database:
   ```bash
   python -m scripts.assign_hs_codes --dry-run
   ```

4. Include AI suggestions for unmatched/uncategorized products:
   ```bash
   python -m scripts.assign_hs_codes --use-ai
   ```

5. See detailed per-product output:
   ```bash
   python -m scripts.assign_hs_codes --verbose
   ```

6. Combine flags as needed:
   ```bash
   python -m scripts.assign_hs_codes --use-ai --dry-run --verbose
   ```

## Configuration

- **seed_mappings.json**: Must exist at `apps/Server/scripts/output/seed_mappings.json` with `categories` and `hs_codes` sections
- **AI suggestions**: Requires `ANTHROPIC_API_KEY` or `OPENAI_API_KEY` environment variable when using `--use-ai`
- **Output**: Results written to `apps/Server/scripts/output/hs_assignment_results.json` (gitignored)

## Testing

- Import validation: `cd apps/Server && python -c "from scripts.assign_hs_codes import CATEGORY_HS_MAP; print(len(CATEGORY_HS_MAP))"`
- Dry-run execution: `cd apps/Server && python -m scripts.assign_hs_codes --dry-run`
- Backend tests: `cd apps/Server && .venv/bin/pytest tests/ -v --tb=short`
- Linting: `cd apps/Server && .venv/bin/ruff check .`

## Notes

- The script is idempotent — products that already have `hs_code_id` are skipped entirely
- Parent-level categories (BAÑOS, MOBILIARIO, PISOS - GUARDAESCOBAS, REVESTIMIENTOS) without direct HS code mappings are treated as unmatched
- No frontend changes — this is a backend-only operational script
- No new dependencies required — follows existing patterns from `import_products.py` and `seed_all.py`
- Part of the SCD pipeline: seed reference data (SCD-001/002) -> import products (SCD-003/004) -> assign HS codes (SCD-005)
